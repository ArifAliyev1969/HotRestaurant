var path = require('path');
var fs = require('fs');
var csv = require('fast-csv');

module.exports = function(filename, cb) {
  var extension = path.extname(filename);

  if (extension === '.json' || extension === '.log') {
    fs.readFile(filename, 'utf8', function(err, stringData) {
      if (err) {
        cb(err);
      } else {
        cb(null, JSON.parse(stringData));
      }
    });

  } else if (extension === '.tsv' || extension === '.csv' || extension === '.txt') {
    var data = [];
    var delim = (extension === '.tsv') ? '\t' : ',';

    var csvOptions = {
      headers: true,
      ignoreEmpty: true,
      delimiter: delim,
      trim: true,
      discardUnmappedColumns: true
    };

    csv.fromPath(filename, csvOptions)
      .on('data', function(item) {
        console.log(JSON.stringify(item, null, 2));
        data.push(item);
      })
      .on('end', function() {
        cb(null, data);
      })
      .on('error', function(err) {
        cb(err);
      });

  } else {
    cb(new TypeError('Extension of ' + extension + ' not recognized.'));
  }
};
